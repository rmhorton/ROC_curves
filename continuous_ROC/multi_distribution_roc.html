<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multi-Distribution ROC Explorer 2</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:18px}
    .controls{display:grid;grid-template-columns:repeat(2,minmax(300px,480px));gap:12px 24px;margin-bottom:12px}
    .ctrl{background:#f7f7fb;border:1px solid #e7e7ee;border-radius:12px;padding:10px}
    .ctrl h3{margin:0 0 6px 0;font-size:15px;color:#333}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0}
    .row label{flex:0 0 120px}
    .row input[type=range]{flex:1}
    .plots{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;margin-bottom:60px}
    #distPlot,#rocPlot{min-width:360px;width:48%;flex:1;height:420px}
    #thresholdArea{display:flex;gap:40px;align-items:flex-start;margin:40px 0 20px 0}
    #thresholdControl,#prevalenceControl{flex:1}
    table{border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:4px 8px;text-align:center}
  </style>
</head>
<body>
  <h2>Multi-Distribution ROC Explorer 2</h2>
  <p>Select distributions for positives and negatives and adjust their parameters. The ROC curve is computed from the CDFs (no sampling).</p>

  <div class="controls">
    <div class="ctrl">
      <h3>Positives</h3>
      <div class="row"><label>Distribution:</label>
        <select id="posDist">
          <option value="normal">Normal</option>
          <option value="beta">Beta</option>
          <option value="exponential">Exponential</option>
          <option value="gamma">Gamma</option>
          <option value="uniform">Uniform</option>
        </select>
      </div>
      <div id="posParams"></div>
    </div>
    <div class="ctrl">
      <h3>Negatives</h3>
      <div class="row"><label>Distribution:</label>
        <select id="negDist">
          <option value="normal">Normal</option>
          <option value="beta">Beta</option>
          <option value="exponential">Exponential</option>
          <option value="gamma">Gamma</option>
          <option value="uniform">Uniform</option>
        </select>
      </div>
      <div id="negParams"></div>
    </div>
  </div>

  <div class="plots">
    <div id="distPlot"></div>
    <div id="rocPlot"></div>
  </div>

  <div id="thresholdArea">
    <div id="thresholdControl">
      <label>Threshold: <input type="range" id="thresholdSlider" step="0.01" value="0.5"></label>
      <span id="thresholdVal">0.50</span>
      <div id="metrics"></div>
    </div>
    <div id="prevalenceControl">
      <label>Prevalence: <input type="range" id="prevalenceSlider" min="0" max="1" step="0.01" value="0.5"></label>
      <span id="prevalenceVal">0.50</span>
      <div id="metricsPrev"></div>
    </div>
  </div>

  <script>
    function getDistFuncs(type,params){
      switch(type){
        case 'normal': return {pdf:(x)=>jStat.normal.pdf(x,params.mean,params.sd),cdf:(x)=>jStat.normal.cdf(x,params.mean,params.sd), domain:[params.mean-4*params.sd,params.mean+4*params.sd]};
        case 'beta': return {pdf:(x)=>jStat.beta.pdf(x,params.a,params.b),cdf:(x)=>jStat.beta.cdf(x,params.a,params.b), domain:[0,1]};
        case 'exponential': return {pdf:(x)=>jStat.exponential.pdf(x,params.lambda),cdf:(x)=>jStat.exponential.cdf(x,params.lambda), domain:[0,5/params.lambda]};
        case 'gamma': return {pdf:(x)=>jStat.gamma.pdf(x,params.k,params.theta),cdf:(x)=>jStat.gamma.cdf(x,params.k,params.theta), domain:[0,5*params.k*params.theta]};
        case 'uniform': return {pdf:(x)=>jStat.uniform.pdf(x,params.a,params.b),cdf:(x)=>jStat.uniform.cdf(x,params.a,params.b), domain:[params.a,params.b]};
      }
    }

    function getParams(prefix){
      switch(document.getElementById(prefix+'Dist').value){
        case 'normal': return {mean: parseFloat(document.getElementById(prefix+'Mean')?.value||0), sd: parseFloat(document.getElementById(prefix+'Sd')?.value||1)};
        case 'beta': return {a: parseFloat(document.getElementById(prefix+'A')?.value||2), b: parseFloat(document.getElementById(prefix+'B')?.value||2)};
        case 'exponential': return {lambda: parseFloat(document.getElementById(prefix+'Lambda')?.value||1)};
        case 'gamma': return {k: parseFloat(document.getElementById(prefix+'K')?.value||2), theta: parseFloat(document.getElementById(prefix+'Theta')?.value||1)};
        case 'uniform': return {a: parseFloat(document.getElementById(prefix+'Min')?.value||0), b: parseFloat(document.getElementById(prefix+'Max')?.value||1)};
      }
    }

    function renderParamControls(prefix){
      const container=document.getElementById(prefix+'Params');
      const type=document.getElementById(prefix+'Dist').value;
      let html="";
      if(type==='normal'){
        html+=`<div class="row"><label>Mean:</label><input id="${prefix}Mean" type="number" value="0" step="0.1"></div>`;
        html+=`<div class="row"><label>SD:</label><input id="${prefix}Sd" type="number" value="1" step="0.1"></div>`;
      } else if(type==='beta'){
        html+=`<div class="row"><label>α:</label><input id="${prefix}A" type="number" value="2" step="0.1"></div>`;
        html+=`<div class="row"><label>β:</label><input id="${prefix}B" type="number" value="2" step="0.1"></div>`;
      } else if(type==='exponential'){
        html+=`<div class="row"><label>λ:</label><input id="${prefix}Lambda" type="number" value="1" step="0.1"></div>`;
      } else if(type==='gamma'){
        html+=`<div class="row"><label>k (shape):</label><input id="${prefix}K" type="number" value="2" step="0.1"></div>`;
        html+=`<div class="row"><label>θ (scale):</label><input id="${prefix}Theta" type="number" value="1" step="0.1"></div>`;
      } else if(type==='uniform'){
        html+=`<div class="row"><label>Min:</label><input id="${prefix}Min" type="number" value="0" step="0.1"></div>`;
        html+=`<div class="row"><label>Max:</label><input id="${prefix}Max" type="number" value="1" step="0.1"></div>`;
      }
      container.innerHTML=html;
      container.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',update));
    }

    function aucFromROC(fpr,tpr){ let area=0; for(let i=1;i<fpr.length;i++){ const dx=fpr[i]-fpr[i-1]; area+=dx*(tpr[i]+tpr[i-1])/2; } return area; }

    function update(){
      const posType=document.getElementById('posDist').value;
      const negType=document.getElementById('negDist').value;
      const posParams=getParams('pos');
      const negParams=getParams('neg');
      const pos=getDistFuncs(posType,posParams);
      const neg=getDistFuncs(negType,negParams);

      let minX=Math.min(pos.domain[0],neg.domain[0]);
      let maxX=Math.max(pos.domain[1],neg.domain[1]);
      if(posType==='beta'||negType==='beta'){minX=0;maxX=1;}

      const slider=document.getElementById('thresholdSlider');
      slider.min=minX; slider.max=maxX;
      const threshold=parseFloat(slider.value);
      document.getElementById('thresholdVal').textContent=threshold.toFixed(2);

      const N=500; const xs=Array.from({length:N},(_,i)=>minX+(maxX-minX)*i/(N-1));
      const posPDF=xs.map(x=>pos.pdf(x));
      const negPDF=xs.map(x=>neg.pdf(x));
      const posCDF=xs.map(x=>pos.cdf(x));
      const negCDF=xs.map(x=>neg.cdf(x));

      // Base outlines only
      let traces=[
        {x:xs,y:posPDF,mode:'lines',name:'Positive PDF',line:{width:3,color:'blue'},fill:null},
        {x:xs,y:negPDF,mode:'lines',name:'Negative PDF',line:{width:3,color:'orange'},fill:null},
        {x:[threshold,threshold],y:[0,Math.max(...posPDF.concat(negPDF))],mode:'lines',name:'Threshold',line:{color:'black',dash:'dot'}}
      ];

      // Shaded regions
      const posLeft=xs.filter(x=>x<=threshold);
      const posRight=xs.filter(x=>x>=threshold);
      const negLeft=xs.filter(x=>x<=threshold);
      const negRight=xs.filter(x=>x>=threshold);
      const posPDFLeft=posLeft.map(x=>pos.pdf(x));
      const posPDFRight=posRight.map(x=>pos.pdf(x));
      const negPDFLeft=negLeft.map(x=>neg.pdf(x));
      const negPDFRight=negRight.map(x=>neg.pdf(x));

      traces.push({x:posLeft,y:posPDFLeft,mode:'lines',fill:'tozeroy',fillcolor:'rgba(200,50,50,0.3)',line:{color:'transparent'},name:'FN'});
      traces.push({x:posRight,y:posPDFRight,mode:'lines',fill:'tozeroy',fillcolor:'rgba(50,200,50,0.3)',line:{color:'transparent'},name:'TP'});
      traces.push({x:negLeft,y:negPDFLeft,mode:'lines',fill:'tozeroy',fillcolor:'rgba(50,200,50,0.3)',line:{color:'transparent'},name:'TN'});
      traces.push({x:negRight,y:negPDFRight,mode:'lines',fill:'tozeroy',fillcolor:'rgba(200,50,50,0.3)',line:{color:'transparent'},name:'FP'});

      Plotly.newPlot('distPlot',traces,{title:'Score Distributions',xaxis:{title:'Score',range:[minX,maxX]},yaxis:{title:'Density'}});

      const TPR=posCDF.map(v=>1-v);
      const FPR=negCDF.map(v=>1-v);
      const pairs=xs.map((x,i)=>({thr:x,fpr:FPR[i],tpr:TPR[i]})).sort((a,b)=>a.fpr-b.fpr);
      const fpr=pairs.map(p=>p.fpr);
      const tpr=pairs.map(p=>p.tpr);
      const auc=aucFromROC(fpr,tpr);
      let thrPoint=pairs.reduce((prev,curr)=>Math.abs(curr.thr-threshold)<Math.abs(prev.thr-threshold)?curr:prev,pairs[0]);

      Plotly.newPlot('rocPlot',[
        {x:fpr,y:tpr,mode:'lines',name:'ROC',line:{width:3}},
        {x:[0,1],y:[0,1],mode:'lines',name:'Random',line:{dash:'dash'}},
        {x:[thrPoint.fpr],y:[thrPoint.tpr],mode:'markers',name:'Threshold Point',marker:{color:'red',size:10}}
      ],{title:`ROC Curve (AUC=${auc.toFixed(3)})`,xaxis:{title:'False Positive Rate',range:[-0.02,1.02]},yaxis:{title:'True Positive Rate',range:[-0.02,1.02]}});

      const sensitivity=thrPoint.tpr;
      const specificity=1-thrPoint.fpr;
      document.getElementById('metrics').innerHTML=
        `<table><tr><th>Sensitivity</th><th>Specificity</th></tr>
        <tr><td>${sensitivity.toFixed(3)}</td><td>${specificity.toFixed(3)}</td></tr></table>`;

      const prevalence=parseFloat(document.getElementById('prevalenceSlider').value);
      document.getElementById('prevalenceVal').textContent=prevalence.toFixed(2);
      const ppv=(sensitivity*prevalence)/((sensitivity*prevalence)+(1-specificity)*(1-prevalence));
      const npv=(specificity*(1-prevalence))/(((1-sensitivity)*prevalence)+(specificity*(1-prevalence)));
      const accuracy=sensitivity*prevalence+specificity*(1-prevalence);
      document.getElementById('metricsPrev').innerHTML=
        `<table><tr><th>PPV</th><th>NPV</th><th>Accuracy</th></tr>
        <tr><td>${ppv.toFixed(3)}</td><td>${npv.toFixed(3)}</td><td>${accuracy.toFixed(3)}</td></tr></table>`;
    }

    document.getElementById('posDist').addEventListener('change',()=>{renderParamControls('pos');update();});
    document.getElementById('negDist').addEventListener('change',()=>{renderParamControls('neg');update();});
    document.getElementById('thresholdSlider').addEventListener('input',update);
    document.getElementById('prevalenceSlider').addEventListener('input',update);

    renderParamControls('pos');
    renderParamControls('neg');
    update();
  </script>
</body>
</html>
